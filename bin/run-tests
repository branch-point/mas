#!/usr/bin/env bash

set -e

function reset_server {
    pm2 stop pm2/test.json
    sleep 5
    redis-cli -p 44144 flushall
    pm2 start pm2/test.json
    sleep 3
}

ROOT=$( cd $( dirname "${BASH_SOURCE[0]}" ) && cd .. && pwd )
cd $ROOT

if [[ ( $# < 1 ) ]]; then
    echo "Usage: $0 <env> [test]"
    exit 1
fi

### Ember tests

cd client && ember test && cd ..

### Nightwatch tests

NIGHTWATCH_ENV=$1

if [[ -z "$2" ]]; then
    SINGLE_TEST=""
else
    SINGLE_TEST="--test $2"
fi

redis-server conf/redis.test.conf
REDIS_PID=$!

echo "Waiting 1 second for the redis to start."
sleep 1

pm2 start pm2/test.json
sleep 3

if [ "$NIGHTWATCH_ENV" == "local" ]; then
    node ./bin/nightwatch --env local $SINGLE_TEST --configFile=test/mas-test.conf
else
    # Can't run in parallel until there are multiple redises.
    node ./bin/nightwatch --env saucelabs-chrome-linux --configFile=test/mas-test.conf
    reset_server
    node ./bin/nightwatch --env saucelabs-ie-win --configFile=test/mas-test.conf
    reset_server
    node ./bin/nightwatch --env saucelabs-firefox-mac --configFile=test/mas-test.conf
fi

pm2 stop pm2/test.json

killall "redis-server *:44144"
