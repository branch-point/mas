#!/usr/bin/env bash

if [ ! $# == 1 ]; then
    echo "Usage: $0 <env>"
    exit 1
fi

NIGHTWATCH_ENV=$1
PASSED="true"

ROOT=$( cd $( dirname "${BASH_SOURCE[0]}" ) && cd .. && pwd )
cd $ROOT

redis-server --port 44144 &
REDIS_PID=$!

echo "Waiting 1 second for the redis to start."
sleep 1

./bin/masctl -b -c start --configFile test/mas-test.conf

./bin/nightwatch --env $NIGHTWATCH_ENV

rc=$?

if [[ $rc != 0 ]]; then
   PASSED="false"
fi

if [[ $NIGHTWATCH_ENV == "saucelabs" ]]; then
    REPORTING_URL="https://saucelabs.com/rest/v1/mas-ci/jobs/travis-build-$TRAVIS_JOB_NUMBER"

    echo "REPORTING: $PASSED"
    echo "URL: $REPORTING_URL"

    curl -X PUT -s -d "{\"passed\": $PASSED}" -u mas-ci:$SAUCE_ACCESS_KEY $REPORTING_URL
fi

./bin/masctl -c stop --configFile test/mas-test.conf

kill $REDIS_PID
wait $REDIS_PID
